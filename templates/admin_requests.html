{% extends "base.html" %}
{% block content %}

<div class="admin-container">
    <!-- Header Section -->
    <div class="admin-page-header">
        <div>
            <h1>Appointment Requests</h1>
        </div>
        <div class="admin-header-actions">
            <a href="{{ url_for('admin_reviews_get') }}" class="btn secondary">Manage Reviews</a>
            <a href="{{ url_for('admin_change_password_get') }}" class="btn secondary">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAADyUlEQVR4nO2a2W9PQRTHP42qn9h/bdWL7VGI9X+wRlQtVfuDpS9K8Gp5k5QXEom/A40oKY19DRFba4lYQhUPotoUP5nk+5NJ3d/tvfObe4v4JpM2vXPOnDNz5pzvzBT+499FFqgGDgJNwCPgI9ADdAMdwGPgJHAAqAFGxhzjGnAlCeMzwDqgGfgO5GI24+QZYBUwOMJ4eTlvGArsAt5Yys2stwB7tDJTgDEycAhQqb8tA/YD54FeS/41sAMoS8uRRcBTS+kNYBMwyjEctwD3LH1twPwkHTFhdMxSdguYiz8sBO5L9w/gsMb06sg4GW6UfAG2AYPwj1KFbLfGuqaQ9OLIZOCJFDwEppE8Zlljmkw3sVhHKqXICF8HKkgP5Uq1OTlV5epIxgqny8Aw0scIJRNjw1VXR45Z4WSyy0ChCnjWp/7ESrH5jZ3GnrgQs5BGLnb5OmGyk2v2qQcuAZ/VLqpmmG+pOLLbqhMuKbbC2qRB7VIaSSNj0Q6XYjfIml0T1ytEDE1bCTzXt9aE6tAvrLVohws2SP6FNmlQYX2pPmasxNCsQQx3ckGL5NeH9NmoPmdJCFngm+iBCwFE549cP3ugUn0+kBCqNYCZVVdEySolwBxgNgnhkIww5wlXeD/4uKBJRiyJKWcy0zuH02G+GdnleESbFJtTXBx0FOFEvr316cgHKc2mHE7ew7FHCstSNsRV/oLaX+3IEMmYUvEbOvWx3KMhE0RAzcFovIN8IVRI5r3PzR5mSK31vdZBvhCmSsZcAv6Gk47pN8wQQ0I/qQ11kC+EpZI5HlYQ9xIP/RnyQs1VPgj7JdMYRlHOEQ/9GVKjGXSVD0KrZBYHfRxjkcbR/LlZK6sM2xt2CX5aSjcnaEix8vXqbyhVQaxRp5sxFL/2QFHMqTQKDHO+LZm6sI4Zy7B5EZXXiCsV40RgrIfc7rxUUQzFTnW+nfS5OiZKgbuyrSGKQMa6d93On4OdsulxlNXIY4GEuoDpDDxmAl9db3eOWjMQl3/5RCXQLluOuCjI9LlAHohL7OF6I8npZ+SQCpqNR9azgv3okjSyupW0nxWKwmRraU2YzSCdPdGuMQ0rn+RLcZUVZl16fQ26jC4WpcpOX61wGut7kIyVAEy7o+zmAyUqdnct/UeK2RNRMN9a9vyt/VaRTpd9UG/RjpxCyedrcb+rY8LrlWVAj+j1PtH2qUrbZWrlejSqUZ9W654gTzsakl6FQjCDrgZO6QgQl2f1isXWDZQDQRgl8mdObSf09tipWe/R7w90PG1U37j/VPMf/C34Cbaqur91vKeeAAAAAElFTkSuQmCC" alt="lock-orientation">
                Change Password</a>
            <form method="post" action="{{ url_for('admin_logout') }}" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-logout" type="submit">Logout</button>
            </form>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card stat-new">
            <div class="stat-content">
                <div class="stat-label">New</div>
                <div class="stat-value">{{ rows | selectattr('status', 'equalto', 'new') | list | length }}</div>
            </div>
        </div>
        <div class="stat-card stat-contacted">
            <div class="stat-content">
                <div class="stat-label">Contacted</div>
                <div class="stat-value">{{ rows | selectattr('status', 'equalto', 'contacted') | list | length }}</div>
            </div>
        </div>
        <div class="stat-card stat-closed">
            <div class="stat-content">
                <div class="stat-label">Closed</div>
                <div class="stat-value">{{ rows | selectattr('status', 'equalto', 'closed') | list | length }}</div>
            </div>
        </div>
        <div class="stat-card stat-total">
            <div class="stat-content">
                <div class="stat-label">Total</div>
                <div class="stat-value">{{ rows | length }}</div>
            </div>
        </div>
    </div>

    <!-- Requests Table -->
    {% if rows %}
    <div class="requests-table-container">
        <table class="requests-table">
            <thead>
                <tr>
                    <th>Created</th>
                    <th>Name</th>
                    <th>Contact</th>
                    <th>Preferred Times</th>
                    <th>Service</th>
                    <th>Note</th>
                    <th>Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            
            <tbody>
            {% for r in rows %}
                <tr class="request-row status-{{ r['status'] }}">
                    <td class="cell-date">
                        <div class="date-display">{{ r["created_at"][:10] }}</div>
                        <div class="time-display">{{ r["created_at"][11:16] }}</div>
                    </td>
                    <td class="cell-name">
                        <strong>{{ r["name"] }}</strong>
                    </td>
                    <td class="cell-contact">{{ r["contact"] }}</td>
                    <td class="cell-times">{{ r["preferred_times"] }}</td>
                    <td class="cell-service">
                        <span class="service-badge">{{ r["service"] }}</span>
                    </td>
                    <td class="cell-note">
                        {% if r["note"] %}
                            <div class="note-preview" title="{{ r['note'] }}">
                                {{ r["note"][:50] }}{% if r["note"]|length > 50 %}...{% endif %}
                            </div>
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td class="cell-status">
                        <span class="status-badge status-{{ r['status'] }}">
                            {% if r["status"] == "new" %}üÜï New
                            {% elif r["status"] == "contacted" %}üìûContacted
                            {% elif r["status"] == "closed" %}‚úÖ Closed
                            {% endif %}
                        </span>
                    </td>
                    <td class="cell-action">
                        <div class="action-buttons">
                            <form method="post" action="/admin/requests/{{ r['id'] }}/status" class="status-form">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <select name="status" class="status-select" onchange="this.form.submit()">
                                    <option value="new" {% if r["status"]=="new" %}selected{% endif %}>New</option>
                                    <option value="contacted" {% if r["status"]=="contacted" %}selected{% endif %}>Contacted</option>
                                    <option value="closed" {% if r["status"]=="closed" %}selected{% endif %}>Closed</option>
                                </select>
                            </form>
                            <button
                                class="btn-delete" 
                                data-id="{{ r['id'] }}" 
                                data-name="{{ r['name'] }}" 
                                title="Delete request">
                                <img width="32" height="32" src="https://img.icons8.com/windows/32/trash.png" alt="trash"/>
                            </button>
                        </div>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">üì≠</div>
        <h2>No appointment requests yet</h2>
        <p>When patients submit appointment requests, they'll appear here.</p>
    </div>
    {% endif %}
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal hidden">
    <div class="modal-backdrop" onclick="hideDeleteModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirm Deletion</h2>
            <button onclick="hideDeleteModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <p id="deleteMessage"></p>
            <p class="warning-text">This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
            <button onclick="hideDeleteModal()" class="btn-cancel">Cancel</button>
            <form id="deleteForm" method="post" style="display: inline;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit" class="btn-confirm-delete">Delete Request</button>
            </form>
        </div>
    </div>
</div>

{% endblock %}